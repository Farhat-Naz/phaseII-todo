# Implementation Plan: Better Auth Integration & Enhanced Authentication

**Branch**: `007-auth-enhancements` | **Date**: 2026-01-13 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/007-auth-enhancements/spec.md`

**Note**: This plan was created by the `/sp.plan` command following the Spec-Driven Development workflow.

## Summary

This feature enhances the existing JWT-based authentication system by adding **7 critical authentication flows**: refresh tokens with rotation, password reset via email, email verification, session management dashboard, HttpOnly cookie storage, rate limiting, and profile updates. The implementation follows the constitution's security-first architecture and agent-driven development principles, building upon the established patterns in `backend/app/auth.py` and `frontend/hooks/useAuth.ts`.

---

## Technical Context

**Language/Version**: Python 3.11+ (backend), TypeScript 5+ (frontend), Node.js 18+
**Primary Dependencies**: FastAPI, SQLModel, Next.js 16+ App Router, python-jose, bcrypt, SendGrid/AWS SES
**Storage**: Neon PostgreSQL (serverless) with 3 new tables (sessions, password_reset_tokens, email_verification_tokens)
**Testing**: pytest (backend), Jest + React Testing Library (frontend)
**Target Platform**: Linux server (backend via Render/Railway), Vercel (frontend)
**Project Type**: web (backend/ and frontend/ directories)
**Performance Goals**: <500ms token refresh latency p95, <2min email delivery p95, 5 login attempts per 15min rate limit
**Constraints**: HttpOnly cookies require same-origin or CORS credentials:true, email service dependency, Redis optional (in-memory for MVP)
**Scale/Scope**: 3 new DB tables, 10+ new endpoints, 69 functional requirements across 7 user stories

---

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Status**: ✅ **PASS** - All requirements align with constitution principles

| Gate | Status | Notes |
|------|--------|-------|
| Agent-Driven Development | ✅ PASS | All implementation via `/sp.implement` with specialized agents |
| Security-First Architecture | ✅ PASS | JWT validation mandatory, user scoping, HttpOnly cookies, rate limiting |
| Skills-First Implementation | ✅ PASS | Extends existing Auth Skill, API Skill, Database Skill patterns |
| Type Safety | ✅ PASS | TypeScript strict mode, Python type hints, Pydantic validation |
| Multi-Tenant Data Isolation | ✅ PASS | All new tables have user_id foreign keys with indexes |
| No Manual Coding | ✅ PASS | 100% agent-generated code via established workflow |

**Re-check Required**: After Phase 1 design artifacts are complete, verify OpenAPI contracts align with FastAPI patterns.

---

## Project Structure

### Documentation (this feature)

```text
specs/007-auth-enhancements/
├── plan.md              # This file (/sp.plan output)
├── research.md          # Phase 0: Email service, cookie strategy, rate limiting
├── data-model.md        # Phase 1: Database schema (3 new tables)
├── quickstart.md        # Phase 1: Developer setup guide
├── contracts/           # Phase 1: OpenAPI specs for new endpoints
│   ├── refresh-token.yaml
│   ├── password-reset.yaml
│   ├── email-verification.yaml
│   ├── session-management.yaml
│   ├── profile-update.yaml
│   └── rate-limiting.yaml
└── tasks.md             # Phase 2: Generated by /sp.tasks (NOT by /sp.plan)
```

### Source Code (repository root)

```text
# Web application structure (backend + frontend)

backend/
├── app/
│   ├── main.py                    # Add middleware for cookies, rate limiting
│   ├── models.py                  # Add 3 new tables: Session, PasswordResetToken, EmailVerificationToken
│   ├── schemas.py                 # Add request/response models for new endpoints
│   ├── auth.py                    # Extend with refresh token, cookie functions
│   ├── dependencies.py            # Add rate limiter dependency
│   ├── services/
│   │   ├── email.py               # NEW: Email service (SendGrid/AWS SES)
│   │   ├── token.py               # NEW: Token generation and validation
│   │   └── rate_limiter.py        # NEW: In-memory rate limiting
│   └── routers/
│       ├── auth.py                # Extend with 10+ new endpoints
│       └── sessions.py            # NEW: Session management endpoints
├── alembic/
│   └── versions/
│       └── 002_add_auth_tables.py # NEW: Migration for 3 tables
├── templates/
│   └── emails/                     # NEW: Email templates
│       ├── password_reset.html
│       ├── email_verification.html
│       ├── password_changed.html
│       └── email_changed.html
└── tests/
    ├── test_refresh_token.py      # NEW: Token rotation tests
    ├── test_password_reset.py     # NEW: Reset flow tests
    ├── test_email_verification.py # NEW: Verification tests
    ├── test_sessions.py           # NEW: Session CRUD tests
    └── test_rate_limiting.py      # NEW: Rate limit tests

frontend/
├── app/
│   ├── [locale]/
│   │   ├── (auth)/
│   │   │   ├── forgot-password/   # NEW: Request reset page
│   │   │   ├── reset-password/    # NEW: Reset form page
│   │   │   └── verify-email/      # NEW: Verification page
│   │   └── (dashboard)/
│   │       └── sessions/          # NEW: Session management page
│   └── api/                       # NEW: Next.js API routes for cookie handling
│       └── auth/
│           └── cookies/
│               └── route.ts       # NEW: Cookie bridge for CORS
├── components/
│   └── features/
│       ├── auth/
│       │   ├── ForgotPasswordForm.tsx    # NEW
│       │   ├── ResetPasswordForm.tsx     # NEW
│       │   ├── EmailVerificationBanner.tsx # NEW
│       │   └── ResendVerificationButton.tsx # NEW
│       └── sessions/
│           ├── SessionList.tsx           # NEW
│           └── SessionCard.tsx           # NEW
├── hooks/
│   ├── useAuth.ts                 # Extend with refresh, reset, verify methods
│   └── useSessions.ts             # NEW: Session management hook
├── lib/
│   ├── api.ts                     # Update with cookie credentials, refresh interceptor
│   └── cookies.ts                 # NEW: Cookie helpers (get/set/remove)
└── types/
    ├── session.ts                 # NEW: Session TypeScript types
    └── auth.ts                    # NEW: Auth flow types
```

**Structure Decision**: Web application structure (Option 2 from template) selected because this is a full-stack feature with backend API endpoints and frontend UI components. The existing monorepo with `backend/` and `frontend/` directories is maintained. All new files extend existing modules following established patterns.

---

## Complexity Tracking

**Status**: N/A - No constitution violations. This feature enhances the existing authentication system within established architectural patterns. No new projects added, no unauthorized architectural changes.

---

## Critical Files for Implementation

Based on this plan, the 5 most critical files are:

1. **backend/app/models.py** - Add 3 new SQLModel tables (Session, PasswordResetToken, EmailVerificationToken) and extend User model with email_verified and last_login fields. Foundation for all auth enhancements.

2. **backend/app/auth.py** - Extend with refresh token creation/validation, cookie management functions, token hashing utilities. Core authentication logic that all new endpoints depend on.

3. **backend/app/routers/auth.py** - Add 10+ new endpoints (refresh, forgot-password, reset-password, verify-email, sessions CRUD, profile update). Primary API surface for all 7 user stories.

4. **frontend/lib/api.ts** - Update with cookie credentials ('include'), automatic refresh token interceptor on 401, and HttpOnly cookie handling. Critical for frontend-backend auth communication.

5. **frontend/hooks/useAuth.ts** - Extend with refresh(), requestPasswordReset(), resetPassword(), verifyEmail(), resendVerification() methods. Main authentication hook that all frontend components use.

---

**Artifacts Status**:
- ✅ plan.md (this file) - Complete
- ⏳ research.md - To be generated in Phase 0
- ⏳ data-model.md - To be generated in Phase 1
- ⏳ contracts/ - To be generated in Phase 1
- ⏳ quickstart.md - To be generated in Phase 1
- ⏳ tasks.md - To be generated by `/sp.tasks` command

**Next Command**: Generate remaining artifacts with Phase 0 and Phase 1 below, then run `/sp.tasks` to create implementation tasks.
